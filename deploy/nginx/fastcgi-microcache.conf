# Include inside http {} context
fastcgi_cache_path /var/cache/nginx/profios levels=1:2 keys_zone=profios_cache:100m inactive=10m max_size=2g;
fastcgi_cache_key "$scheme$request_method$host$request_uri";

# Include inside server {} context for PHP location
set $skip_cache 0;
if ($request_method = POST) { set $skip_cache 1; }
if ($query_string != "") { set $skip_cache 1; }
if ($request_uri ~* "^/admin|^/setup") { set $skip_cache 1; }
if ($http_cookie ~* "profios_cms_session") { set $skip_cache 1; }

location ~ \.php$ {
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass unix:/run/php/php-fpm.sock;

    fastcgi_cache_bypass $skip_cache;
    fastcgi_no_cache $skip_cache;
    fastcgi_cache profios_cache;
    fastcgi_cache_valid 200 302 60s;
    fastcgi_cache_valid 404 10s;
    fastcgi_cache_use_stale error timeout invalid_header updating http_500 http_503;
    add_header X-Microcache $upstream_cache_status;
}
